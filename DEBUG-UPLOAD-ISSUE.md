# üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–±–ª–µ–º —Å –ö–∞—á–≤–∞–Ω–µ—Ç–æ –Ω–∞ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

## ‚ùå –ü–†–û–ë–õ–ï–ú
–ê–ø–ª–∏–∫–∞—Ü–∏—è—Ç–∞ –∫—Ä–∞—à–≤–∞ –∫–æ–≥–∞—Ç–æ —Å–µ –æ–ø–∏—Ç–≤–∞—Ç–µ –¥–∞ –∫–∞—á–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ –∞–Ω–∞–ª–∏–∑.

## üéØ –í–™–ó–ú–û–ñ–ù–ò –ü–†–ò–ß–ò–ù–ò

### 1. **RACE CONDITION –≤ React State** (–ù–ê–ô-–í–ï–†–û–Ø–¢–ù–û)
**–ö–∞–∫–≤–æ —Å–µ —Å–ª—É—á–≤–∞:**
- –ö–æ–≥–∞—Ç–æ –∫–∞—á–≤–∞—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Ç–æ —Å–µ –∑–∞–ø–∏—Å–≤–∞ –≤ state —á—Ä–µ–∑ `setLeftImage()` –∏–ª–∏ `setRightImage()`
- State update-–∏—Ç–µ –≤ React —Å–∞ **–ê–°–ò–ù–•–†–û–ù–ù–ò**
- –ö–æ–≥–∞—Ç–æ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ó–∞–ø–æ—á–Ω–∏ –ê–Ω–∞–ª–∏–∑", —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ `handleNext()` —á–µ—Ç–µ `leftImage` –∏ `rightImage` –æ—Ç state
- **–ù–û** –∞–∫–æ state update-—ä—Ç –Ω–µ –µ –∑–∞–≤—ä—Ä—à–∏–ª, `leftImage` –∏–ª–∏ `rightImage` –º–æ–∂–µ –¥–∞ —Å–∞:
  - `null`
  - `undefined`
  - –û–±–µ–∫—Ç –ë–ï–ó `dataUrl` property

**–ö—ä–¥–µ –∫—Ä–∞—à–≤–∞:**
```typescript
// App.tsx, –ª–∏–Ω–∏—è 83-86
const handleImagesComplete = async (left: IrisImage, right: IrisImage) => {
    errorLogger.info('APP_IMAGES_COMPLETE', 'handleImagesComplete called', {
      leftSize: Math.round(left.dataUrl.length / 1024),  // ‚ùå CRASH —Ç—É–∫ –∞–∫–æ left.dataUrl –µ undefined
      rightSize: Math.round(right.dataUrl.length / 1024), // ‚ùå CRASH —Ç—É–∫ –∞–∫–æ right.dataUrl –µ undefined
```

### 2. **–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –î–∞–Ω–Ω–∏ –æ—Ç Crop Editor**
**–ö–∞–∫–≤–æ —Å–µ —Å–ª—É—á–≤–∞:**
- `IrisCropEditor` –≥–µ–Ω–µ—Ä–∏—Ä–∞ cropped –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –≥–æ –ø–æ–¥–∞–≤–∞ –∫—ä–º `handleCropSave()`
- –ê–∫–æ crop –æ–ø–µ—Ä–∞—Ü–∏—è—Ç–∞ —Å–µ –ø—Ä–æ–≤–∞–ª–∏, –º–æ–∂–µ –¥–∞ –≤—ä—Ä–Ω–µ –ø—Ä–∞–∑–µ–Ω –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω string
- State update-—ä—Ç –∑–∞–ø–∏—Å–≤–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏

### 3. **Memory/Quota Exceeded**
**–ö–∞–∫–≤–æ —Å–µ —Å–ª—É—á–≤–∞:**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ —Å–∞ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª–µ–º–∏ –∏ browser-—ä—Ç –Ω—è–º–∞ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –ø–∞–º–µ—Ç
- –ö–æ–º–ø—Ä–µ—Å–∏—è—Ç–∞ –Ω–µ —Ä–∞–±–æ—Ç–∏ –∫–∞–∫—Ç–æ —Ç—Ä—è–±–≤–∞
- Browser-—ä—Ç –∫—Ä–∞—à–≤–∞ —Ü–µ–ª–∏—è runtime

### 4. **Browser Storage Limit**
**–ö–∞–∫–≤–æ —Å–µ —Å–ª—É—á–≤–∞:**
- Spark KV storage –∏–º–∞ –ª–∏–º–∏—Ç
- –ö–æ–≥–∞—Ç–æ —Å–µ –æ–ø–∏—Ç–∞—Ç–µ –¥–∞ –∑–∞–ø–∞–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞, storage-—ä—Ç –µ –ø—ä–ª–µ–Ω
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –∫—Ä–∞—à–≤–∞ –ø—Ä–∏ –æ–ø–∏—Ç –∑–∞ –∑–∞–ø–∏—Å

## üõ†Ô∏è –ö–ê–ö –î–ê –ü–†–û–í–ï–†–ò–¢–ï

### –°—Ç—ä–ø–∫–∞ 1: –û—Ç–≤–æ—Ä–µ—Ç–µ Browser Console
1. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ `F12` –∏–ª–∏ `Right Click -> Inspect`
2. –û—Ç–∏–¥–µ—Ç–µ –Ω–∞ —Ç–∞–± "Console"
3. –û–ø–∏—Ç–∞–π—Ç–µ –¥–∞ –∫–∞—á–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

### –°—Ç—ä–ø–∫–∞ 2: –ù–∞–±–ª—é–¥–∞–≤–∞–π—Ç–µ –õ–æ–≥–æ–≤–µ—Ç–µ
–©–µ –≤–∏–¥–∏—Ç–µ –¥–µ—Ç–∞–π–ª–Ω–∏ –ª–æ–≥–æ–≤–µ –∫–∞—Ç–æ:
```
üîç [UPLOAD] ========== handleCropSave CALLED ==========
üìä [UPLOAD] croppedDataUrl type: string
üìä [UPLOAD] croppedDataUrl length: 45678
üìä [UPLOAD] editingSide: left
üíæ [UPLOAD] Setting left image in state NOW...
‚úÖ [UPLOAD] setLeftImage() called
```

### –°—Ç—ä–ø–∫–∞ 3: –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∑–∞ –ì—Ä–µ—à–∫–∏
–ê–∫–æ –≤–∏–¥–∏—Ç–µ:
- `‚ùå CRITICAL ERROR:` - –∫—Ä–∏—Ç–∏—á–Ω–∞ –≥—Ä–µ—à–∫–∞
- `‚ö†Ô∏è` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- –ß–µ—Ä–≤–µ–Ω–∏ error —Å—ä–æ–±—â–µ–Ω–∏—è

### –°—Ç—ä–ø–∫–∞ 4: –ê–∫—Ç–∏–≤–∏—Ä–∞–π—Ç–µ Debug Panel
1. –í –µ–∫—Ä–∞–Ω–∞ –∑–∞ –∞–Ω–∞–ª–∏–∑ (–∫–æ–≥–∞—Ç–æ —Å–µ –æ–ø–∏—Ç–∞ –¥–∞ –∑–∞—Ä–µ–∂–¥–∞), –∏–º–∞ –±—É—Ç–æ–Ω "–ü–æ–∫–∞–∂–∏ –ª–æ–≥–æ–≤–µ"
2. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ –≥–æ
3. –©–µ –≤–∏–¥–∏—Ç–µ –≤—Å–∏—á–∫–∏ debug –ª–æ–≥–æ–≤–µ –æ—Ç –∞–Ω–∞–ª–∏–∑–∞

## üîß –ù–ê–ü–†–ê–í–ï–ù–ò –ü–†–û–ú–ï–ù–ò

### 1. –î–æ–±–∞–≤–µ–Ω–æ –î–µ—Ç–∞–π–ª–Ω–æ –õ–æ–≥–≤–∞–Ω–µ
- **ImageUploadScreen.tsx**: –î–æ–±–∞–≤–µ–Ω–∏ console.log statements –≤—ä–≤ –≤—Å—è–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ —Ç–æ—á–∫–∞
- **App.tsx**: –î–æ–±–∞–≤–µ–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ–¥–∏ –¥–æ—Å—Ç—ä–ø–≤–∞–Ω–µ –Ω–∞ properties

### 2. –î–æ–±–∞–≤–µ–Ω–∏ Safety Checks
```typescript
// App.tsx - handleImagesComplete
if (!left || !right) {
  console.error('‚ùå CRITICAL ERROR: left or right is null/undefined!')
  toast.error('–ö—Ä–∏—Ç–∏—á–Ω–∞ –≥—Ä–µ—à–∫–∞: –õ–∏–ø—Å–≤–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞')
  return  // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ –≤–º–µ—Å—Ç–æ –¥–∞ –∫—Ä–∞—à–Ω–µ
}

if (!left.dataUrl || !right.dataUrl) {
  console.error('‚ùå CRITICAL ERROR: dataUrl is missing!')
  toast.error('–ö—Ä–∏—Ç–∏—á–Ω–∞ –≥—Ä–µ—à–∫–∞: –ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞')
  return  // –ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ –≤–º–µ—Å—Ç–æ –¥–∞ –∫—Ä–∞—à–Ω–µ
}
```

### 3. –ü–æ-–ü–æ–¥—Ä–æ–±–Ω–∞ –í–∞–ª–∏–¥–∞—Ü–∏—è
```typescript
// ImageUploadScreen.tsx - handleNext
if (typeof leftImage.dataUrl !== 'string' || typeof rightImage.dataUrl !== 'string') {
  throw new Error('–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ç–∏–ø –¥–∞–Ω–Ω–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞')
}

if (leftImage.dataUrl.length < 100 || rightImage.dataUrl.length < 100) {
  throw new Error('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ —Å–∞ —Ç–≤—ä—Ä–¥–µ –º–∞–ª–∫–∏ –∏–ª–∏ –ø–æ–≤—Ä–µ–¥–µ–Ω–∏')
}

if (!leftImage.dataUrl.startsWith('data:image/')) {
  throw new Error('–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç (–Ω–µ —Å–∞ base64 data URL)')
}
```

## üìã –°–õ–ï–î–í–ê–©–ò –°–¢–™–ü–ö–ò –ó–ê –¢–ï–°–¢–í–ê–ù–ï

### –¢–µ—Å—Ç 1: –ú–∞–ª–∫–æ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (< 100KB)
1. –ù–∞–º–µ—Ä–µ—Ç–µ –º–∞–ª–∫–∞ —Å–Ω–∏–º–∫–∞ (—Ç–µ–ª–µ—Ñ–æ–Ω –∫–∞–º–µ—Ä–∞ —Å –Ω–∏—Å–∫–æ –∫–∞—á–µ—Å—Ç–≤–æ)
2. –ö–∞—á–µ—Ç–µ –≥–æ –∫–∞—Ç–æ –ª—è–≤ –∏—Ä–∏—Å
3. Crop-–Ω–µ—Ç–µ –≥–æ
4. –ü–æ–≥–ª–µ–¥–Ω–µ—Ç–µ console - —Ç—Ä—è–±–≤–∞ –¥–∞ –≤–∏–¥–∏—Ç–µ:
   ```
   ‚úÖ [UPLOAD] Left iris saved successfully
   üìä [UPLOAD] leftImage exists: true
   ```
5. –ö–∞—á–µ—Ç–µ –≤—Ç–æ—Ä–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞ –¥–µ—Å–µ–Ω –∏—Ä–∏—Å
6. –ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ó–∞–ø–æ—á–Ω–∏ –ê–Ω–∞–ª–∏–∑"
7. –ü—Ä–æ—Å–ª–µ–¥–µ—Ç–µ console –∑–∞ –≥—Ä–µ—à–∫–∏

### –¢–µ—Å—Ç 2: –°—Ä–µ–¥–Ω–æ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (100-500KB)
–ü–æ–≤—Ç–æ—Ä–µ—Ç–µ —Å—ä—â–æ—Ç–æ –∫–∞—Ç–æ –¢–µ—Å—Ç 1

### –¢–µ—Å—Ç 3: –ì–æ–ª—è–º–æ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (> 1MB)
–ü–æ–≤—Ç–æ—Ä–µ—Ç–µ —Å—ä—â–æ—Ç–æ –∫–∞—Ç–æ –¢–µ—Å—Ç 1

## üêõ –ö–ê–ö–í–û –î–ê –¢–™–†–°–ò–¢–ï –í CONSOLE

### –£—Å–ø–µ—à–µ–Ω Flow:
```
‚úÇÔ∏è [UPLOAD] ========== handleCropSave CALLED ==========
üìä [UPLOAD] croppedDataUrl type: string
üìä [UPLOAD] croppedDataUrl length: 45678
‚úÖ [UPLOAD] IrisImage object created: { side: 'left', dataUrlLength: 45678 }
üíæ [UPLOAD] Setting left image in state NOW...
‚úÖ [UPLOAD] setLeftImage() called
‚úÖ [UPLOAD] Left iris saved successfully
üìä [UPLOAD] leftImage exists: true
üìä [UPLOAD] rightImage exists: false

[... —Å–ª–µ–¥ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ –≤—Ç–æ—Ä–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ...]

üìä [UPLOAD] leftImage exists: true
üìä [UPLOAD] rightImage exists: true

[... —Å–ª–µ–¥ –Ω–∞—Ç–∏—Å–∫–∞–Ω–µ "–ó–∞–ø–æ—á–Ω–∏ –ê–Ω–∞–ª–∏–∑" ...]

üîç [APP] ========== handleImagesComplete CALLED ==========
üîç [APP] left parameter: {dataUrl: "data:image/jpeg;base64,...", side: "left"}
üîç [APP] right parameter: {dataUrl: "data:image/jpeg;base64,...", side: "right"}
‚úÖ [APP] Images validated successfully
üöÄ [APP] Transitioning to analysis screen...
```

### –ü—Ä–æ–±–ª–µ–º–µ–Ω Flow (Race Condition):
```
‚úÖ [UPLOAD] Left iris saved successfully
üìä [UPLOAD] leftImage exists: false  // ‚ùå –ü–†–û–ë–õ–ï–ú! –¢—Ä—è–±–≤–∞ –¥–∞ –µ true!

[... –∏–ª–∏ ...]

üîç [APP] ========== handleImagesComplete CALLED ==========
üîç [APP] left is null? false
üîç [APP] left.dataUrl? MISSING  // ‚ùå –ü–†–û–ë–õ–ï–ú! dataUrl –ª–∏–ø—Å–≤–∞!
‚ùå [APP] CRITICAL ERROR: dataUrl is missing!
```

## üí° –í–™–ó–ú–û–ñ–ù–ò –†–ï–®–ï–ù–ò–Ø

### –†–µ—à–µ–Ω–∏–µ 1: –£–≤–µ–ª–∏—á–µ—Ç–µ Delay-–∞
–ê–∫–æ –ø—Ä–æ–±–ª–µ–º—ä—Ç –µ race condition, –º–æ–∂–µ—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–∞ —É–≤–µ–ª–∏—á–∏—Ç–µ delay-–∞:

–í `ImageUploadScreen.tsx`, –ª–∏–Ω–∏—è ~269:
```typescript
// –ü—Ä–æ–º–µ–Ω–µ—Ç–µ –æ—Ç 100ms –Ω–∞ 500ms
await new Promise(resolve => setTimeout(resolve, 500))
```

### –†–µ—à–µ–Ω–∏–µ 2: –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ useRef –≤–º–µ—Å—Ç–æ state
–í–º–µ—Å—Ç–æ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ state –∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞, –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ refs (–∫–æ–µ—Ç–æ –≤–µ—á–µ –ø—Ä–∞–≤–∏—Ç–µ –≤ App.tsx).

### –†–µ—à–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–µ—Ç–µ Callback —Å–ª–µ–¥ State Update
–ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ useEffect –¥–∞ —Å–ª–µ–¥–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ –≤ state –∏ –¥–∞ notification-–≤–∞ –∫–æ–≥–∞—Ç–æ –µ –≥–æ—Ç–æ–≤–æ.

### –†–µ—à–µ–Ω–∏–µ 4: –ü—Ä–µ—Ö–≤—ä—Ä–ª–µ—Ç–µ –í–∞–ª–∏–¥–∞—Ü–∏—è—Ç–∞ –ø—Ä–µ–¥–∏ State Update
–í–∞–ª–∏–¥–∏—Ä–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –ü–†–ï–î–ò –¥–∞ –≥–æ –∑–∞–ø–∏—à–µ—Ç–µ –≤ state, –Ω–µ —Å–ª–µ–¥ —Ç–æ–≤–∞.

## üìû –ó–ê –°–™–û–ë–©–ê–í–ê–ù–ï –ù–ê –ü–†–û–ë–õ–ï–ú–ê

–ö–æ–≥–∞—Ç–æ —Å—ä–æ–±—â–∞–≤–∞—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞, –º–æ–ª—è –≤–∫–ª—é—á–µ—Ç–µ:

1. **Browser Console Logs** - copy/paste –≤—Å–∏—á–∫–∏ —á–µ—Ä–≤–µ–Ω–∏ –≥—Ä–µ—à–∫–∏
2. **–†–∞–∑–º–µ—Ä –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ** - –º–∞–ª–∫–æ/—Å—Ä–µ–¥–Ω–æ/–≥–æ–ª—è–º–æ
3. **–§–æ—Ä–º–∞—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ** - JPG/PNG/etc
4. **–ë—Ä–∞—É–∑—ä—Ä –∏ –≤–µ—Ä—Å–∏—è** - Chrome 120, Firefox 121, etc
5. **–¢–æ—á–Ω–æ –≤ –∫–æ–π –º–æ–º–µ–Ω—Ç –∫—Ä–∞—à–≤–∞** - –ø—Ä–∏ crop, –ø—Ä–∏ –∑–∞–ø–∏—Å, –ø—Ä–∏ "–ó–∞–ø–æ—á–Ω–∏ –ê–Ω–∞–ª–∏–∑"
6. **Debug Panel –ª–æ–≥–æ–≤–µ** - –∞–∫–æ —Å—Ç–∏–≥–Ω–µ—Ç–µ –¥–æ analysis screen

## ‚úÖ –û–ß–ê–ö–í–ê–ù–ò –†–ï–ó–£–õ–¢–ê–¢–ò

–°–ª–µ–¥ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ, —Å–µ–≥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ:
1. **–ù–ï —Ç—Ä—è–±–≤–∞** –¥–∞ –∫—Ä–∞—à–≤–∞ - —â–µ –ø–æ–∫–∞–∑–≤–∞ error —Å—ä–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Ç–æ–≤–∞
2. **–©–µ –ª–æ–≥–≤–∞** –¥–µ—Ç–∞–π–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≤—Å—è–∫–∞ —Å—Ç—ä–ø–∫–∞
3. **–©–µ –≤–∞–ª–∏–¥–∏—Ä–∞** –¥–∞–Ω–Ω–∏—Ç–µ –ø—Ä–µ–¥–∏ –¥–∞ –≥–∏ –∏–∑–ø–æ–ª–∑–≤–∞
4. **–©–µ –ø–æ–∫–∞–∑–≤–∞** –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ error —Å—ä–æ–±—â–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ generic crash

---

**–î–∞—Ç–∞ –Ω–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ:** 2025-01-XX
**–í–µ—Ä—Å–∏—è –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
**–ê–≤—Ç–æ—Ä:** Spark Agent
