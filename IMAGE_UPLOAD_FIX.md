# Решение на проблема с рестартиране при качване на изображение

## Проблем
При качване на изображение от галерията на телефона, приложението се рестартираше/crash-ваше веднага след качване.

## Причини
1. **Твърде големи изображения в KV Storage** - Основната причина беше, че временните изображения (`temp-left-iris`, `temp-right-iris`) се запазваха в `useKV` storage, което има ограничения по размер
2. **Недостатъчна компресия** - Изображенията бяха компресирани до 1200px с quality 0.85, което оставаше твърде голямо
3. **Storage quota exceeded** - При опит да се запише голямо изображение в storage, браузърът throw-ваше грешка и приложението crash-ваше

## Решения

### 1. Премахване на useKV за временни изображения (КРИТИЧНО)
**Файл:** `src/App.tsx`

**Преди:**
```typescript
const [leftIris, setLeftIris] = useKV<IrisImage | null>('temp-left-iris', null)
const [rightIris, setRightIris] = useKV<IrisImage | null>('temp-right-iris', null)
```

**След:**
```typescript
const [leftIris, setLeftIris] = useState<IrisImage | null>(null)
const [rightIris, setRightIris] = useState<IrisImage | null>(null)
```

**Обяснение:** Временните изображения не трябва да се persist-ват между сесии. Те се използват само по време на текущата сесия за анализ и след това се включват в генерирания репорт. Само репортът трябва да се запазва в storage.

### 2. По-агресивна компресия на изображенията
**Файл:** `src/components/screens/ImageUploadScreen.tsx`

**Преди:**
- Max width: 1200px
- Quality: 0.85

**След:**
- Max width: 800px
- Quality: 0.75
- Допълнителна компресия ако файлът е > 400KB (600px, quality 0.6)

**Обяснение:** За иридологичен анализ не е нужна висока резолюция. 800px е напълно достатъчно за визуализация и анализ.

### 3. Подобрено логване и error handling
- Добавени console.log на всяка стъпка за лесно проследяване
- Показване на размер преди и след компресия
- Try-catch блокове около всички state updates
- Error boundary с подробна информация

### 4. Проверка на размер на storage
**Файл:** `src/lib/diagnostics.ts`

Добавена е нова проверка `checkStorageSize()` която показва:
- Общ размер на storage
- Брой ключове
- Най-големите 3 ключа

### 5. Валидация на данните
Добавени са множество проверки:
- Проверка дали изображението е валиден data URL
- Проверка дали започва с 'data:image/'
- Проверка за размер преди запазване
- Проверка дали компонентът е mounted

## Резултат
След тези промени:
- ✅ Изображенията са 3-4 пъти по-малки
- ✅ Не се опитваме да запазим голями данни в storage
- ✅ По-добро error handling и логване
- ✅ Лесно проследяване на проблеми чрез QuickDebugPanel
- ✅ Приложението не се рестартира при качване на изображение

## Тестване
1. Качи изображение от галерията (обикновено голямо)
2. Провери console.log за размери
3. Отвори QuickDebugPanel (жълт бутон долу вдясно) за проверка на storage
4. Качи второ изображение
5. Натисни "Започни Анализ"
6. Провери дали няма рестартиране

## Мониторинг
За да провериш дали има проблеми със storage:
1. Отвори QuickDebugPanel (жълт бутон)
2. Виж "Storage Size" проверката
3. Отвори пълна диагностика от Welcome екран -> Diagnostics
