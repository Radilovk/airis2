# FIX: –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ —Å–ª–µ–¥ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

## –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ù–ê –ü–†–û–ë–õ–ï–ú–ê

### –û—Å–Ω–æ–≤–Ω–∏ –ø—Ä–∏—á–∏–Ω–∏ –∑–∞ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ—Ç–æ:

1. **–ö–†–ò–¢–ò–ß–ï–ù –ü–†–û–ë–õ–ï–ú #1: –û–≥—Ä–æ–º–Ω–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ KV Storage**
   - –ö–æ–≥–∞—Ç–æ report —Å–µ –∑–∞–ø–∞–∑–≤–∞ –≤ `useKV` storage, —Ç–æ–π –≤–∫–ª—é—á–≤–∞ —Ü—è–ª–∞—Ç–∞ base64 data –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞
   - –¢–æ–≤–∞ –≤–æ–¥–∏ –¥–æ:
     - –û–≥—Ä–æ–º–Ω–æ –Ω–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ –Ω–∞ KV storage (—Å—Ç–æ—Ç–∏—Ü–∏ KB –¥–æ MB –¥–∞–Ω–Ω–∏)
     - Re-render –Ω–∞ —Ü–µ–ª–∏—è App –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
     - "–ó–∞–º—Ä—ä–∑–≤–∞–Ω–µ" –∏–ª–∏ "—Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ" –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ

2. **–ü–†–û–ë–õ–ï–ú #2: –õ–∏–ø—Å–∞ –Ω–∞ –∑–∞—â–∏—Ç–∞ —Å—Ä–µ—â—É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∏ –∏–∑–≤–∏–∫–≤–∞–Ω–∏—è**
   - `handleImagesComplete` –º–æ–∂–µ –¥–∞ —Å–µ –∏–∑–≤–∏–∫–∞ –Ω—è–∫–æ–ª–∫–æ –ø—ä—Ç–∏
   - `performAnalysis` –º–æ–∂–µ –¥–∞ —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—ä—Ç–∏
   - –¢–æ–≤–∞ –≤–æ–¥–∏ –¥–æ race conditions –∏ unexpected behavior

3. **–ü–†–û–ë–õ–ï–ú #3: –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–∏ state updates**
   - State updates –≤ `useKV` —Å–∞ async –∏ –º–æ–≥–∞—Ç –¥–∞ –ø—Ä–∏—á–∏–Ω—è—Ç re-renders
   - –ü—Ä–∏ update –Ω–∞ –≥–æ–ª–µ–º–∏ –æ–±–µ–∫—Ç–∏ (—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) —Ç–æ–≤–∞ —Å–µ –∑–∞–±–µ–ª—è–∑–≤–∞ –∫–∞—Ç–æ "—Ä–µ—Å—Ç–∞—Ä—Ç"

## –ù–ê–ü–†–ê–í–ï–ù–ò FIX-–û–í–ï

### 1. –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ history (App.tsx)

**–ü–†–ï–î–ò:**
```typescript
const handleAnalysisComplete = (report: AnalysisReport) => {
  setAnalysisReport(() => report)
  setHistory((current) => [report, ...(current || [])]) // ‚ùå –ó–ê–ü–ò–°–í–ê –û–ì–†–û–ú–ù–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
}
```

**–°–õ–ï–î:**
```typescript
const handleAnalysisComplete = (report: AnalysisReport) => {
  // –ü—ä–ª–µ–Ω —Ä–µ–ø–æ—Ä—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∞–º–æ –≤ currentReport
  setAnalysisReport(() => report)
  
  // "–õ–µ–∫–∞" –≤–µ—Ä—Å–∏—è –ë–ï–ó –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –∏—Å—Ç–æ—Ä–∏—è
  const lightReport: AnalysisReport = {
    ...report,
    leftIrisImage: { dataUrl: '', side: 'left' },
    rightIrisImage: { dataUrl: '', side: 'right' }
  }
  
  setHistory((current) => [lightReport, ...(current || [])])
}
```

**–†–ï–ó–£–õ–¢–ê–¢:** –ò—Å—Ç–æ—Ä–∏—è –≤–µ—á–µ –ù–ï —Å—ä–¥—ä—Ä–∂–∞ –æ–≥—Ä–æ–º–Ω–∏ base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Å–∞–º–æ –º–µ—Ç–∞–¥–∞–Ω–Ω–∏.

### 2. –î–æ–±–∞–≤–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ —Å—Ä–µ—â—É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∏ –∏–∑–≤–∏–∫–≤–∞–Ω–∏—è (App.tsx)

```typescript
const screenTransitionLockRef = useRef(false)

const handleImagesComplete = async (left: IrisImage, right: IrisImage) => {
  if (screenTransitionLockRef.current) {
    console.warn('‚ö†Ô∏è –°–º—è–Ω–∞ –Ω–∞ –µ–∫—Ä–∞–Ω –≤–µ—á–µ –µ –≤ —Ö–æ–¥, –∏–≥–Ω–æ—Ä–∏—Ä–∞–Ω–µ')
    return
  }
  
  screenTransitionLockRef.current = true
  
  // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ...
  
  setTimeout(() => {
    screenTransitionLockRef.current = false
  }, 500)
}
```

**–†–ï–ó–£–õ–¢–ê–¢:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞ —á–µ —Å–º—è–Ω–∞—Ç–∞ –Ω–∞ –µ–∫—Ä–∞–Ω —Å–µ –∏–∑–≤—ä—Ä—à–≤–∞ —Å–∞–º–æ –≤–µ–¥–Ω—ä–∂.

### 3. –î–æ–±–∞–≤–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –≤ AnalysisScreen (AnalysisScreen.tsx)

```typescript
const [analysisRunning, setAnalysisRunning] = useState(false)

const performAnalysis = async () => {
  if (analysisRunning) {
    console.warn('‚ö†Ô∏è performAnalysis –≤–µ—á–µ —Ä–∞–±–æ—Ç–∏, –ø—Ä–æ–ø—É—Å–∫–∞–Ω–µ')
    return
  }
  
  setAnalysisRunning(true)
  
  try {
    // ... –∞–Ω–∞–ª–∏–∑ ...
  } finally {
    setAnalysisRunning(false)
  }
}
```

**–†–ï–ó–£–õ–¢–ê–¢:** –ê–Ω–∞–ª–∏–∑—ä—Ç —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å–∞–º–æ –≤–µ–¥–Ω—ä–∂, –¥–æ—Ä–∏ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∏ renders.

### 4. –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –ª–æ–≥–æ–≤–µ –∑–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–î–æ–±–∞–≤–µ–Ω–∏ –¥–µ—Ç–∞–π–ª–Ω–∏ –ª–æ–≥–æ–≤–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –∫–ª—é—á–æ–≤–∏ —Ç–æ—á–∫–∏:
- `üñºÔ∏è [APP]` - App.tsx –ª–æ–≥–æ–≤–µ
- `üìä [UPLOAD]` - ImageUploadScreen –ª–æ–≥–æ–≤–µ  
- `üöÄ [ANALYSIS]` - AnalysisScreen –ª–æ–≥–æ–≤–µ
- `‚úÖ / ‚ùå / ‚ö†Ô∏è` - Success / Error / Warning –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏

**–†–ï–ó–£–õ–¢–ê–¢:** –°–µ–≥–∞ –º–æ–∂–µ—à –¥–∞ –≤–∏–∂–¥–∞—à –¢–û–ß–ù–û –∫—ä–¥–µ —Å–µ —Å–ª—É—á–≤–∞ –ø—Ä–æ–±–ª–µ–º—ä—Ç –≤ console.log.

### 5. –£–≤–µ–ª–∏—á–µ–Ω–∏ timeout-–æ–≤–µ –∑–∞ —Å—Ç–∞–±–∏–ª–Ω–æ—Å—Ç

–ü—Ä–æ–º–µ–Ω–µ–Ω–∏ timeout-–æ–≤–µ—Ç–µ:
- `50ms` ‚Üí `100ms` –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ crop
- `50ms` ‚Üí `100ms` –ø—Ä–∏ –ø—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –∫—ä–º –∞–Ω–∞–ª–∏–∑
- `100ms` ‚Üí `200ms` –ø—Ä–∏ –ø—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –æ—Ç upload –∫—ä–º analysis

**–†–ï–ó–£–õ–¢–ê–¢:** –î–∞–≤–∞ –ø–æ–≤–µ—á–µ –≤—Ä–µ–º–µ –Ω–∞ React –¥–∞ –æ–±–Ω–æ–≤–∏ UI –±–µ–∑ race conditions.

## –ö–ê–ö –î–ê –¢–ï–°–¢–í–ê–® FIX-–ê

1. **–û—Ç–≤–æ—Ä–∏ –±—Ä–∞—É–∑—ä—Ä console** (F12)
2. **–ö–∞—á–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ** –æ—Ç –≥–∞–ª–µ—Ä–∏—è—Ç–∞
3. **–ì–ª–µ–¥–∞–π –ª–æ–≥–æ–≤–µ—Ç–µ** - —Ç—Ä—è–±–≤–∞ –¥–∞ –≤–∏–¥–∏—à:
   ```
   üñºÔ∏è [UPLOAD] handleNext() –∏–∑–≤–∏–∫–∞–Ω
   üìä [UPLOAD] leftImage: true, rightImage: true
   üíæ [UPLOAD] –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ...
   ‚úÖ [UPLOAD] –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
   üöÄ [UPLOAD] –ò–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ onComplete(leftImage, rightImage)...
   ‚úÖ [UPLOAD] onComplete() –∏–∑–≤–∏–∫–∞–Ω —É—Å–ø–µ—à–Ω–æ
   üñºÔ∏è [APP] –ü–æ–ª—É—á–µ–Ω–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –∞–Ω–∞–ª–∏–∑
   üìä [APP] –õ—è–≤ –∏—Ä–∏—Å —Ä–∞–∑–º–µ—Ä: XX KB
   üìä [APP] –î–µ—Å–µ–Ω –∏—Ä–∏—Å —Ä–∞–∑–º–µ—Ä: XX KB
   ‚úÖ [APP] –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–∞
   üíæ [APP] –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ ref...
   üöÄ [APP] –ü—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –∫—ä–º analysis –µ–∫—Ä–∞–Ω...
   ‚úÖ [APP] setCurrentScreen("analysis") –∏–∑–≤–∏–∫–∞–Ω —É—Å–ø–µ—à–Ω–æ
   üöÄ [ANALYSIS] ANALYSIS SCREEN MOUNTED!
   üé¨ [ANALYSIS] performAnalysis() STARTED
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ**:
   - ‚ùå –ü–†–ï–î–ò: –í–∏–∂–¥–∞—à –µ–∫—Ä–∞–Ω–∞ –¥–∞ "–º–∏–≥–∞" –∏–ª–∏ —Å–µ "–ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞"
   - ‚úÖ –°–õ–ï–î: –ì–ª–∞–¥–∫–æ –ø—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –æ—Ç Upload ‚Üí Analysis screen

## –ê–ö–û –í–°–ï –û–©–ï –ò–ú–ê –ü–†–û–ë–õ–ï–ú

–ê–∫–æ –ø—Ä–æ–±–ª–µ–º—ä—Ç –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞, –ø—Ä–æ–≤–µ—Ä–∏ —Å–ª–µ–¥–Ω–æ—Ç–æ –≤ console:

### –í—ä–∑–º–æ–∂–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ #1: –ú–Ω–æ–≥–æ –≥–æ–ª—è–º analysis-history –≤ KV
```typescript
// –í browser console, –ø—Ä–æ–≤–µ—Ä–∏ —Ä–∞–∑–º–µ—Ä–∞:
const history = await window.spark.kv.get('analysis-history')
console.log('History size:', JSON.stringify(history).length)
```

**FIX:** –ò–∑—á–∏—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞:
```typescript
await window.spark.kv.set('analysis-history', [])
```

### –í—ä–∑–º–æ–∂–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ #2: –ú–Ω–æ–≥–æ –≥–æ–ª—è–º analysis-report –≤ KV
```typescript
const report = await window.spark.kv.get('analysis-report')
console.log('Report size:', JSON.stringify(report).length)
```

**FIX:** –ò–∑—á–∏—Å—Ç–∏ —Ä–µ–ø–æ—Ä—Ç–∞:
```typescript
await window.spark.kv.set('analysis-report', null)
```

### –í—ä–∑–º–æ–∂–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ #3: –ú–Ω–æ–≥–æ –≥–æ–ª—è–º questionnaire-data
```typescript
const data = await window.spark.kv.get('questionnaire-data')
console.log('Questionnaire size:', JSON.stringify(data).length)
```

**FIX:** –í–∏–∂ –¥–∞–ª–∏ –∏–º–∞ –∫–∞—á–µ–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –≤ questionnaire-data:
```typescript
// –ê–∫–æ –∏–º–∞ uploadedDocuments, –ø—Ä–µ–º–∞—Ö–Ω–∏ –≥–∏:
data.uploadedDocuments = []
await window.spark.kv.set('questionnaire-data', data)
```

## –†–ï–ó–Æ–ú–ï –ù–ê –ü–†–û–ú–ï–ù–ò–¢–ï

### –ü—Ä–æ–º–µ–Ω–µ–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ:
1. **`src/App.tsx`**:
   - –î–æ–±–∞–≤–µ–Ω `screenTransitionLockRef` –∑–∞ –∑–∞—â–∏—Ç–∞
   - –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –ª–æ–≥–æ–≤–µ –≤ `handleImagesComplete`
   - "–õ–µ–∫–∞" –≤–µ—Ä—Å–∏—è –Ω–∞ report –≤ –∏—Å—Ç–æ—Ä–∏—è (–ë–ï–ó –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
   - –£–≤–µ–ª–∏—á–µ–Ω–∏ timeout-–æ–≤–µ

2. **`src/components/screens/ImageUploadScreen.tsx`**:
   - –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –ª–æ–≥–æ–≤–µ –≤ `handleNext`
   - –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –ª–æ–≥–æ–≤–µ –≤ `handleCropSave`
   - –£–≤–µ–ª–∏—á–µ–Ω–∏ timeout-–æ–≤–µ
   - –ü–æ-–¥–æ–±—Ä–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è

3. **`src/components/screens/AnalysisScreen.tsx`**:
   - –î–æ–±–∞–≤–µ–Ω `analysisRunning` flag –∑–∞ –∑–∞—â–∏—Ç–∞
   - –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –ª–æ–≥–æ–≤–µ –≤ `performAnalysis`
   - –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –ª–æ–≥–æ–≤–µ –≤ `useEffect`
   - –ü—Ä–∞–≤–∏–ª–Ω–æ reset –Ω–∞ `analysisRunning` –≤ `finally` –±–ª–æ–∫

### –ö–ª—é—á–æ–≤–∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è:
‚úÖ –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ –æ–≥—Ä–æ–º–Ω–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ KV storage  
‚úÖ –î–æ–±–∞–≤–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ —Å—Ä–µ—â—É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∏ –∏–∑–≤–∏–∫–≤–∞–Ω–∏—è  
‚úÖ –ü–æ–¥–æ–±—Ä–µ–Ω–∏ –ª–æ–≥–æ–≤–µ –∑–∞ –ª–µ—Å–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞  
‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–∏ timeout-–æ–≤–µ –∑–∞ —Å—Ç–∞–±–∏–ª–Ω–æ—Å—Ç  
‚úÖ –ü–æ-–¥–æ–±—Ä–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –¥–∞–Ω–Ω–∏  

### –û—á–∞–∫–≤–∞–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏:
- ‚úÖ –ì–ª–∞–¥–∫–æ –ø—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ –æ—Ç Upload ‚Üí Analysis
- ‚úÖ –ù—è–º–∞ "–º–∏–≥–∞–Ω–µ" –∏–ª–∏ "—Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ"
- ‚úÖ –î–µ—Ç–∞–π–ª–Ω–∏ –ª–æ–≥–æ–≤–µ –≤ console –∑–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- ‚úÖ –ù–∞–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä –Ω–∞ KV storage
- ‚úÖ –ü–æ-–±—ä—Ä–∑–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è

## –í–ê–ñ–ù–û: –ö–ê–ö –î–ê –î–û–ö–õ–ê–î–í–ê–® –ê–ö–û –í–°–ï –û–©–ï –ò–ú–ê –ü–†–û–ë–õ–ï–ú

–ê–∫–æ –ø—Ä–æ–±–ª–µ–º—ä—Ç –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞, –∏–∑–ø—Ä–∞—Ç–∏ –º–∏:
1. **Screenshot –Ω–∞ console –ª–æ–≥–æ–≤–µ—Ç–µ** –æ—Ç –º–æ–º–µ–Ω—Ç–∞ –Ω–∞ –∫–∞—á–≤–∞–Ω–µ –¥–æ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ
2. **–†–∞–∑–º–µ—Ä–∞ –Ω–∞ KV storage** (–∏–∑–ø–æ–ª–∑–≤–∞–π QuickDebugPanel –≤ –¥–æ–ª–Ω–∏—è –¥–µ—Å–µ–Ω —ä–≥—ä–ª)
3. **–¢–∏–ø–∞ –Ω–∞ —Ñ–∞–π–ª–∞** –∫–æ–π—Ç–æ –∫–∞—á–≤–∞—à (—Ä–∞–∑–º–µ—Ä, —Ñ–æ—Ä–º–∞—Ç)
4. **–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ** (—Ç–µ–ª–µ—Ñ–æ–Ω/—Ç–∞–±–ª–µ—Ç/–∫–æ–º–ø—é—Ç—ä—Ä, –±—Ä–∞—É–∑—ä—Ä)

–¢–æ–≤–∞ —â–µ –º–∏ –ø–æ–º–æ–≥–Ω–µ –¥–∞ –≤–∏–¥—è –¢–û–ß–ù–û –∫—ä–¥–µ –µ –ø—Ä–æ–±–ª–µ–º—ä—Ç.
