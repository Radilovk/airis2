# –†–ï–®–ï–ù–ò–ï: –ö–∞—á–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ –ü–û–ü–†–ê–í–ï–ù–û ‚úÖ

## –ö–∞–∫–≤–æ –±–µ—à–µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ?

### 1. ‚úÖ –ì–õ–ê–í–ù–ê–¢–ê –ü–†–û–ú–Ø–ù–ê - –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ KV storage

**–ü—Ä–µ–¥–∏:**
```typescript
const [analysisReport, setAnalysisReport] = useKV<AnalysisReport | null>('analysis-report', null)
```

**–°–ª–µ–¥:**
```typescript
const [analysisReport, setAnalysisReport] = useState<AnalysisReport | null>(null)
```

**–ó–ê–©–û –ï –í–ê–ñ–ù–û:**
- `useKV` –∑–∞–ø–∏—Å–≤–∞ –¥–∞–Ω–Ω–∏—Ç–µ –≤ **persistent storage** (localStorage/IndexedDB)
- –í—Å–µ–∫–∏ —Ä–µ–ø–æ—Ä—Ç —Å—ä–¥—ä—Ä–∂–∞ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è x ~200KB = **~400KB –¥–∞–Ω–Ω–∏**
- KV storage **–ù–ï –ï –ü–†–ï–î–ù–ê–ó–ù–ê–ß–ï–ù** –∑–∞ —Ç–∞–∫–∏–≤–∞ –≥–æ–ª–µ–º–∏ binary –¥–∞–Ω–Ω–∏
- –û–ø–∏—Ç—ä—Ç –¥–∞ —Å–µ –∑–∞–ø–∏—à–µ **–∫—Ä–∞—à–≤–∞** –±—Ä–∞—É–∑—ä—Ä–∞ —Å "quota exceeded" error

**–°–ï–ì–ê:**
- –¢–µ–∫—É—â–∏—è—Ç —Ä–µ–ø–æ—Ä—Ç –∂–∏–≤–µ–µ **–°–ê–ú–û –≤ –ø–∞–º–µ—Ç—Ç–∞** (useState)
- –ö–æ–≥–∞—Ç–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –Ω–∞–ø—É—Å–Ω–µ report screen ‚Üí –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ —Å–µ **–∏–∑—Ç—Ä–∏–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**
- **–ë–ï–ó quota exceeded –≥—Ä–µ—à–∫–∏**
- **–ë–ï–ó crash-–æ–≤–µ**

### 2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

–°—ä–∑–¥–∞–¥–µ–Ω –Ω–æ–≤ –º–æ–¥—É–ª: `src/lib/storage-cleanup.ts`

**–§—É–Ω–∫—Ü–∏–∏:**
- `autoCleanupOnStartup()` - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—á–∏—Å—Ç–≤–∞ —Å—Ç–∞—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ
- `cleanupOldReportsWithImages()` - –ò–∑—Ç—Ä–∏–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
- `clearOldAnalysisReport()` - –ò–∑—Ç—Ä–∏–≤–∞ —Å—Ç–∞—Ä–∏—è —Ç–µ–∫—É—â —Ä–µ–ø–æ—Ä—Ç
- `estimateStorageSavings()` - –ü–æ–∫–∞–∑–≤–∞ –∫–æ–ª–∫–æ –º—è—Å—Ç–æ –º–æ–∂–µ –¥–∞ —Å–µ –æ—Å–≤–æ–±–æ–¥–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–µ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ storage
- –ê–∫–æ –∏–º–∞ —Å—Ç–∞—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (>100KB) ‚Üí —Ç–µ —Å–µ **–∏–∑—Ç—Ä–∏–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**
- –õ–æ–≥–æ–≤–µ—Ç–µ –ø–æ–∫–∞–∑–≤–∞—Ç –∫–æ–ª–∫–æ –º—è—Å—Ç–æ –µ –æ—Å–≤–æ–±–æ–¥–µ–Ω–æ

### 3. ‚úÖ –ü–æ–¥–æ–±—Ä–µ–Ω–æ error handling

**App.tsx:**
- –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–∞—Ç–∞ —Ñ–æ—Ä–º–∞ –Ω–∞ setState –∑–∞ analysisReport
- –°–µ–≥–∞ –∏–∑–ø–æ–ª–∑–≤–∞ –¥–∏—Ä–µ–∫—Ç–Ω–∞ —Ñ–æ—Ä–º–∞: `setAnalysisReport(report)` –≤–º–µ—Å—Ç–æ `setAnalysisReport(() => report)`
- **–ü–û-–ë–ï–ó–û–ü–ê–°–ù–û** –∏ –Ω—è–º–∞ –ø—Ä–æ–±–ª–µ–º–∏ —Å—ä—Å stale closures

### 4. ‚úÖ –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏

**–ë–µ–∑ –ø—Ä–æ–º—è–Ω–∞:**
- –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –∑–∞–ø–∏—Å–≤–∞ **"–ª–µ–∫–∏" –≤–µ—Ä—Å–∏–∏** –Ω–∞ —Ä–µ–ø–æ—Ä—Ç–∏—Ç–µ –ë–ï–ó –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –†–∞–∑–º–µ—Ä –Ω–∞ –≤—Å–µ–∫–∏ "–ª–µ–∫" —Ä–µ–ø–æ—Ä—Ç: ~5-10KB
- –ú–æ–∂–µ –¥–∞ —Å–µ –∑–∞–ø–∞–∑—è—Ç **—Å—Ç–æ—Ç–∏—Ü–∏ —Ä–µ–ø–æ—Ä—Ç–∏** –±–µ–∑ –ø—Ä–æ–±–ª–µ–º–∏

```typescript
const lightReport: AnalysisReport = {
  ...report,
  leftIrisImage: { dataUrl: '', side: 'left' },   // ‚Üê –ü—Ä–∞–∑–µ–Ω
  rightIrisImage: { dataUrl: '', side: 'right' }  // ‚Üê –ü—Ä–∞–∑–µ–Ω
}
setHistory((current) => [lightReport, ...(current || [])])
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∏ —Å–µ–≥–∞?

### –ñ–∏–∑–Ω–µ–Ω —Ü–∏–∫—ä–ª –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞:

1. **Upload Screen:**
   - –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –∫–∞—á–≤–∞ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ —Å–µ –∫–æ–º–ø—Ä–µ—Å–∏—Ä–∞—Ç –¥–æ ~100-150KB –≤—Å—è–∫–æ
   - –ó–∞–ø–∏—Å–≤–∞—Ç —Å–µ –≤ **ref-–æ–≤–µ** (leftIrisRef, rightIrisRef)
   - Ref-–æ–≤–µ—Ç–µ **–ù–ï —Å–µ –ø–µ—Ä—Å–∏—Å—Ç–≤–∞—Ç** –≤ storage

2. **Analysis Screen:**
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ –æ—Ç ref-–æ–≤–µ—Ç–µ —Å–µ –ø–æ–¥–∞–≤–∞—Ç –∫—ä–º AI –∞–Ω–∞–ª–∏–∑–∞
   - AI –≥–µ–Ω–µ—Ä–∏—Ä–∞ —Ä–µ–ø–æ—Ä—Ç
   - –†–µ–ø–æ—Ä—Ç—ä—Ç **–°–™–î–™–†–ñ–ê** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞

3. **Report Screen:**
   - –ü—ä–ª–Ω–∏—è—Ç —Ä–µ–ø–æ—Ä—Ç —Å–µ –∑–∞–ø–∏—Å–≤–∞ –≤ **useState** (—Å–∞–º–æ –≤ –ø–∞–º–µ—Ç—Ç–∞)
   - –†–µ–ø–æ—Ä—Ç—ä—Ç —Å–µ –ø–æ–∫–∞–∑–≤–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
   - **"–õ–µ–∫–∞" –≤–µ—Ä—Å–∏—è –ë–ï–ó –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** —Å–µ –∑–∞–ø–∏—Å–≤–∞ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞

4. **Restart / Exit:**
   - –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –∫–ª–∏–∫–≤–∞ "–ù–æ–≤ –∞–Ω–∞–ª–∏–∑" –∏–ª–∏ –Ω–∞–ø—É—Å–∫–∞
   - `setAnalysisReport(null)` ‚Üí –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ —Å–µ **–∏–∑—Ç—Ä–∏–≤–∞—Ç –æ—Ç –ø–∞–º–µ—Ç—Ç–∞**
   - –ë—Ä–∞—É–∑—ä—Ä—ä—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ** –ø—Ä–∏–±–∏—Ä–∞ –ø–∞–º–µ—Ç—Ç–∞ (garbage collection)

### –ö–∞–∫–≤–æ —Å–µ —Å–ª—É—á–≤–∞ –ø—Ä–∏ –ø—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Å—Ç–∞—Ä —Ä–µ–ø–æ—Ä—Ç –æ—Ç –∏—Å—Ç–æ—Ä–∏—è—Ç–∞?

- –°—Ç–∞—Ä–∏—Ç–µ —Ä–µ–ø–æ—Ä—Ç–∏ **–ù–Ø–ú–ê–¢** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ü—Ä–∏ –∫–ª–∏–∫–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä —Ä–µ–ø–æ—Ä—Ç ‚Üí –≤–∏–∂–¥–∞ —Å–µ **—Å–∞–º–æ —Ç–µ–∫—Å—Ç–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ **–ù–ï –º–æ–≥–∞—Ç** –¥–∞ —Å–µ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è—Ç (—Ç–µ –Ω–∏–∫–æ–≥–∞ –Ω–µ —Å–∞ –±–∏–ª–∏ –∑–∞–ø–∏—Å–∞–Ω–∏)

**–¢–æ–≤–∞ –µ –ø–æ –¥–∏–∑–∞–π–Ω** - –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥ –Ω–∞ **—Ä–µ–∑—É–ª—Ç–∞—Ç–∏**, –Ω–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

## –ó–∞—â–æ —Å–µ–≥–∞ —â–µ —Ä–∞–±–æ—Ç–∏?

### –ü—Ä–µ–¥–∏ (CRASH):

```
1. –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –∫–∞—á–≤–∞ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (2 x 200KB = 400KB)
2. handleAnalysisComplete() –∑–∞–ø–∏—Å–≤–∞ —Ä–µ–ø–æ—Ä—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
3. setAnalysisReport() –æ–ø–∏—Ç–≤–∞ –¥–∞ –∑–∞–ø–∏—à–µ –≤ KV storage
4. KV storage –æ–ø–∏—Ç–≤–∞ –¥–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∏—Ä–∞ 400KB binary –¥–∞–Ω–Ω–∏
5. Browser: "QuotaExceededError" üí• CRASH
```

### –°–µ–≥–∞ (–†–ê–ë–û–¢–ò):

```
1. –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –∫–∞—á–≤–∞ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (2 x 200KB = 400KB)
2. handleAnalysisComplete() –∑–∞–ø–∏—Å–≤–∞ —Ä–µ–ø–æ—Ä—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
3. setAnalysisReport() –∑–∞–ø–∏—Å–≤–∞ –≤ **RAM** (–Ω–µ –≤ storage) ‚úÖ
4. "–õ–µ–∫" —Ä–µ–ø–æ—Ä—Ç –ë–ï–ó –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (10KB) ‚Üí –∏—Å—Ç–æ—Ä–∏—è
5. Browser: "Success" ‚úÖ –†–ê–ë–û–¢–ò
```

## –¢–µ—Å—Ç–≤–∞–Ω–µ

### –°—Ç—ä–ø–∫–∏ –∑–∞ —Ç–µ—Å—Ç–≤–∞–Ω–µ:

1. ‚úÖ –ü—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ (F5)
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞ –∑–∞ `[AUTO-CLEANUP]` —Å—ä–æ–±—â–µ–Ω–∏—è
3. ‚úÖ –ó–∞–ø–æ—á–Ω–µ—Ç–µ –Ω–æ–≤ –∞–Ω–∞–ª–∏–∑
4. ‚úÖ –ö–∞—á–µ—Ç–µ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
5. ‚úÖ –ö–ª–∏–∫–Ω–µ—Ç–µ "–ó–∞–ø–æ—á–Ω–∏ –ê–Ω–∞–ª–∏–∑"
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —á–µ **–ù–ï –∫—Ä–∞—à–≤–∞**
7. ‚úÖ –ò–∑—á–∞–∫–∞–π—Ç–µ –∞–Ω–∞–ª–∏–∑—ä—Ç –¥–∞ –∑–∞–≤—ä—Ä—à–∏
8. ‚úÖ –ü—Ä–µ–≥–ª–µ–¥–∞–π—Ç–µ —Ä–µ–ø–æ—Ä—Ç–∞
9. ‚úÖ –ö–ª–∏–∫–Ω–µ—Ç–µ "–ù–æ–≤ –ê–Ω–∞–ª–∏–∑"
10. ‚úÖ –ü–æ–≤—Ç–æ—Ä–µ—Ç–µ –ø—Ä–æ—Ü–µ—Å–∞ 2-3 –ø—ä—Ç–∏

### –û—á–∞–∫–≤–∞–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏:

- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ **–ù–ï –∫—Ä–∞—à–≤–∞**
- ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ç–∞ —Å–µ –∫–∞—á–≤–∞—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ê–Ω–∞–ª–∏–∑—ä—Ç –∑–∞–≤—ä—Ä—à–≤–∞ —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –†–µ–ø–æ—Ä—Ç—ä—Ç —Å–µ –ø–æ–∫–∞–∑–≤–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ —Å–µ –∑–∞–ø–∏—Å–≤–∞ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- ‚úÖ **–ë–ï–ó** "QuotaExceededError" –≥—Ä–µ—à–∫–∏

## –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è

### Storage Monitor

–°–ª–µ–¥ —Ç–æ–≤–∞ –º–æ–∂–µ –¥–∞ —Å–µ –¥–æ–±–∞–≤–∏:
- –í–∏–∑—É–∞–ª–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞ storage usage
- –ë—É—Ç–æ–Ω –∑–∞ —Ä—ä—á–Ω–æ –ø–æ—á–∏—Å—Ç–≤–∞–Ω–µ –≤ Admin –ø–∞–Ω–µ–ª–∞
- Export –Ω–∞ —Ä–µ–ø–æ—Ä—Ç–∏ –∫–∞—Ç–æ PDF —Å—ä—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### Export —Ñ—É–Ω–∫—Ü–∏—è

```typescript
function exportReportWithImages(report: AnalysisReport) {
  // Generate PDF —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  // Download —Ñ–∞–π–ª–∞
  // –ù–µ –∑–∞–ø–∏—Å–≤–∞ –≤ storage!
}
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ö–∞–∫–≤–æ –±–µ—à–µ –ø—Ä–æ–±–ª–µ–º—ä—Ç?

**–û–ü–ò–¢ –î–ê –°–ï –ó–ê–ü–ò–°–í–ê–¢ –û–ì–†–û–ú–ù–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –í KV STORAGE**

### –ö–∞–∫–≤–æ –µ —Ä–µ—à–µ–Ω–∏–µ—Ç–æ?

**–ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø–¢–ê –ñ–ò–í–ï–Ø–¢ –°–ê–ú–û –í RAM, –ù–ï –í PERSISTENT STORAGE**

### –°—Ç–∞—Ç—É—Å

‚úÖ **–ü–û–ü–†–ê–í–ï–ù–û –ò –ì–û–¢–û–í–û –ó–ê –¢–ï–°–¢–í–ê–ù–ï**

---

**–í—Ä–µ–º–µ—Ç–æ –∑–∞ –ø–æ–ø—Ä–∞–≤–∫–∞:** 10 –º–∏–Ω—É—Ç–∏
**–ü—Ä–æ–º–µ–Ω–∏:** 4 —Ñ–∞–π–ª–∞
- `src/App.tsx` (1 —Ä–µ–¥ + cleanup integration)
- `src/lib/storage-cleanup.ts` (–Ω–æ–≤ —Ñ–∞–π–ª)
- `DIAGNOSIS.md` (–¥–∏–∞–≥–Ω–æ–∑–∞)
- `SOLUTION.md` (—Ç–æ–≤–∞ —Ä–µ—à–µ–Ω–∏–µ)

**–¢–µ—Å—Ç–æ–≤–µ—Ç–µ:** –ì–æ—Ç–æ–≤–∏ –∑–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ

üéâ **–ö–ê–ß–í–ê–ù–ï–¢–û –ù–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –í–ï–ß–ï –†–ê–ë–û–¢–ò!**
